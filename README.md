# Telegram Summary Bot

Telegram-бот для автоматического создания ежедневных сводок групповых чатов с использованием LLM (OpenAI).

## Возможности

- Работает в группах; поддерживает несколько групповых чатов
- Ежедневные сводки по расписанию (по умолчанию 23:00 по местному времени)
- Команды для администраторов:
  - `/summary_now` — создать и отправить сводку за последние 24 часа немедленно
  - `/setsummarytime HH:MM` — установить время сводки (24-часовой формат)
  - `/settimezone <IANA tz>` — установить таймзону чата (например, Europe/Moscow)
  - `/setmodel <name>` — установить модель LLM (например, gpt-4o-mini)
  - `/setmaxlen <n>` — ограничить длину исходного текста (символы) для контроля стоимости
  - `/settings` — показать текущие настройки
- Безопасная суммаризация: разбивает длинные транскрипты на части и объединяет частичные сводки
- Игнорирует команды и служебные сообщения

## Быстрый старт

### 1. Создание бота

1. Напишите [@BotFather](https://t.me/BotFather) в Telegram
2. Создайте нового бота командой `/newbot`
3. Получите `BOT_TOKEN`
4. **Важно:** Отключите Privacy Mode для бота:
   - `/setprivacy` → выберите вашего бота → `Disable`
   - Это необходимо, чтобы бот мог читать сообщения в группе

### 2. Настройка проекта

1. Скопируйте `.env.example` в `.env`:
   ```bash
   copy .env.example .env
   ```

2. Откройте `.env` и заполните:
   - `BOT_TOKEN` — токен от BotFather
   - `OPENAI_API_KEY` — ваш API ключ OpenAI

3. Установите зависимости:
   ```bash
   pip install -r requirements.txt
   ```

### 3. Запуск

#### Вариант A: Запуск без Docker

```bash
python telegram_summary_bot_daily_group_summaries_with_llm_python_aiogram.py
```

#### Вариант B: Запуск с Docker (рекомендуется)

1. Создайте директорию для данных (если используете SQLite):
   ```bash
   mkdir data
   ```

2. Запустите через Docker Compose:
   ```bash
   docker-compose up -d
   ```

   Или соберите и запустите вручную:
   ```bash
   docker build -t telegram-summary-bot .
   docker run -d --name telegram-summary-bot --env-file .env -v ./data:/app/data telegram-summary-bot
   ```

3. Просмотр логов:
   ```bash
   docker-compose logs -f
   # или
   docker logs -f telegram-summary-bot
   ```

4. Остановка:
   ```bash
   docker-compose down
   # или
   docker stop telegram-summary-bot
   ```

### 4. Добавление в группу

1. Добавьте бота в группу
2. Сделайте бота администратором (рекомендуется)
3. Настройте время и таймзону:
   - `/settimezone Europe/Moscow`
   - `/setsummarytime 23:00`
4. Проверьте настройки: `/settings`

## Переменные окружения

Все настройки находятся в файле `.env`. См. `.env.example` для примера.

## База данных

По умолчанию используется SQLite (`summarybot.db`). Для PostgreSQL укажите `DATABASE_URL` в `.env`.

## Развертывание

Бот должен работать как долго живущий процесс. Подходит для:
- VPS/VDS (с Docker)
- Railway
- Render
- Fly.io
- Heroku
- Любой хостинг с поддержкой Docker

### Docker на продакшене

Для продакшена рекомендуется:
1. Использовать PostgreSQL вместо SQLite (раскомментируйте секцию в `docker-compose.yml`)
2. Настроить volume для персистентного хранения данных
3. Использовать Docker Compose для управления сервисами
4. Настроить автоматический перезапуск через `restart: unless-stopped`

## Переменные окружения (дополнительные)

Дополнительные параметры для оптимизации работы с API:

- `MAX_CHUNKS=5` - Максимальное количество частей для обработки (по умолчанию 5). Ограничивает количество запросов к API.
- `CHUNK_DELAY=1.5` - Задержка между запросами к API в секундах (по умолчанию 1.5). Помогает избежать rate limiting.

## Примечания

- Бот игнорирует не-текстовые сообщения по умолчанию
- Для очень активных чатов рекомендуется PostgreSQL и увеличение `MAX_SOURCE_CHARS`
- Стоимость зависит от объема сообщений и выбранной модели LLM
- Бот автоматически ограничивает количество запросов к API и добавляет задержки между запросами для предотвращения rate limiting

